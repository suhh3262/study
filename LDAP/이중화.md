# ì´ì¤‘í™” êµ¬ì„± í…ŒìŠ¤íŠ¸
<br>

### í…ŒìŠ¤íŠ¸ í™˜ê²½
`master` : master <br>
`slave01` : slave  <br>
`slave02` : slave <br>
+ë¡œì»¬ ë¦¬í¬ì§€í† ë¦¬ êµ¬ì„±

<br>

|Hostname|IP|Role|
|-----|------|------|
|master|192.168.56.11|Master (Provider)|
|slave01|192.168.56.12|Slave (Consumer)|
|slave02|192.168.56.14|Slave (Consumer)|

![Image](https://github.com/user-attachments/assets/b348ed22-f2ad-4693-bd95-b732a131dfeb)

<br>

---

### <mark style='background-color: #ffdce0'> 1. Master, Slave ê³µí†µ í™˜ê²½ ìƒì„± </mark>
- ë‘ ëŒ€ì˜ LDAP ì„œë²„ë¥¼ Master-Slave êµ¬ì¡°ë¡œ ë§Œë“¤ê¸° ì „, ldap ì„œë¹„ìŠ¤ ì„¤ì¹˜
- ì•„ë˜ ì„¤ì •ì€ ë‘ ëŒ€ì— ëª¨ë‘ ë™ì¼í•˜ê²Œ ì ìš©

<br>

#### 1. í•„ìš” íŒ¨í‚¤ì§€ ì„¤ì¹˜
   ```
   yum -y install openldap compat-openldap openldap-clients openldap-servers openldap-servers-sql openldap-devel
   ```

#### 2. slapd ë°ëª¬ ìë™ì‹œì‘ ì„¤ì • ë° êµ¬ë™
   ```
   # systemctl start slapd
   # systemctl enable slapd
   ```

#### 3. 389 portê°€ ì •ìƒì ìœ¼ë¡œ listen ì¤‘ì¸ì§€ í™•ì¸ í›„, ë°©í™”ë²½ì— í•´ë‹¹ í¬íŠ¸ í—ˆìš© ì¶”ê°€
   ```
   # netstat-tupln | grep 389
   # firewalld-cmd --permanent --zone=public --add-port=389/tcp
   # firewalld-cmd --zone=public -add-port=389/tcp
   // ë‚œ ê·¸ëƒ¥ ë°©í™”ë²½ ë„ê³  ì§„í–‰í•˜ë®¤
   ```

#### 4. LDAP ê´€ë ¨ ë¡œê·¸ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ rsyslog ì„¤ì • ë³€ê²½
   ```
   # vi /etc/rsyslog.conf
   ```
   ![Image](https://github.com/user-attachments/assets/0ffef99d-32bc-4789-a2c7-527386d3f590)
   ```
   # systemctl restart rsyslog
   ```

#### 5. /etc/hostsì— ê° ì„œë²„ì˜ ì •ë³´ ë„£ê¸°
   ```
   # vi /etc/hosts
   ```
   ![Image](https://github.com/user-attachments/assets/af7f62f7-b24c-4d29-8be1-6d8a13462288)

#### 6. LDAP Admin Password ì„¸íŒ…
   ```
   # slappasswd

   New password:
   Re-enter new password:
   {SSHA}JCTZ/3YY6qxVBQ49pX9sij1ghSt1Su2n      //docker 2
   {SSHA}Nx3Oy3xKC2nnM/X+NlilvowPdkfQogZj      //docker 1
   ```

#### 7. LDAP ì„œë²„ ì„¤ì •
   - ì„¤ì •íŒŒì¼ì„ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•Šê³  ìƒˆë¡œìš´ íŒŒì¼ì„ ìƒì„±í•˜ì—¬ ì ìš©ì‹œí‚¬ ê²ƒì„
   - ìˆ˜ì •í•  ë‚´ìš©
      - `olcSuffix` : Database Suffixë¡œ, LDAP ì„œë²„ê°€ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ë„ë©”ì¸ ì´ë¦„. ì—¬ê¸°ì„œëŠ” test.localì— í•´ë‹¹
      - `olcRootDN` : root ìœ ì €ì²˜ëŸ¼ LDAPì— ìˆì–´ ëª¨ë“  ê´€ë¦¬ì ê¶Œí•œì„ ìˆ˜í–‰í•˜ëŠ” ìœ ì €ë¥¼ ìœ„í•œ RDN (Root Distinguished Name) Entry
      - `olcRootPW` : ìœ„ RootDNì„ ìœ„í•œ Root PW

<br>

   #### 7.1 íŒŒì¼ ì„¤ì •
    
    # vi db.ldif
    
    dn: olcDatabase={2}hdb,cn=config
    changetype: modify
    replace: olcSuffix
    olcSuffix: dc=test,dc=local
    
    dn: olcDatabase={2}hdb,cn=config
    changetype: modify
    replace: olcRootDN
    olcRootDN: cn=ldapadm,dc=test,dc=local
    
    dn: olcDatabase={2}hdb,cn=config
    changetype: modify
    replace: olcRootPW
    olcRootPW: {SSHA}JCTZ/3YY6qxVBQ49pX9sij1ghSt1Su2n
    
    
   #### 7.2 íŒŒì¼ ì ìš©
   
    # ldapmodify -Y EXTERNAL -H ldapi:/// -f db.ldif
    
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    modifying entry "olcDatabase={2}hdb,cn=config"
    modifying entry "olcDatabase={2}hdb,cn=config"
    modifying entry "olcDatabase={2}hdb,cn=config"
    
    
   #### 7.3 monitor.ldif ìƒì„± (root ì‚¬ìš©ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡)
   
   ```
   # vi monitor.ldif

   dn:olcDatabase={1}monitor,cn=config
   changetype: modify
   replace: olcAccess
   olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth" read by dn.base="cn=ldapadm,dc=test,dc=local" read by * none
   ```
    
   ```
   [root@docker2 ~]# ldapmodify -Y EXTERNAL -H ldapi:/// -f monitor.ldif
   SASL/EXTERNAL authentication started
   SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
   SASL SSF: 0
   modifying entry "olcDatabase={1}monitor,cn=config"
   ```

<br>

  #### 8. LDAP DB ì„¤ì •
     - DB ìƒ˜í”Œ íŒŒì¼ì„ cpí•œ í›„, ê¶Œí•œ ìˆ˜ì •
       ```
       [root@docker2 ~]# cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
       [root@docker2 ~]# chown ldap:ldap /var/lib/ldap/*
       ```

     - LDAP DBì— consineê³¼ nis ìŠ¤í‚¤ë§ˆ ì¶”ê°€
       ```
       # ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
       # ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif 
       # ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif
       ```

     - ë„ë©”ì¸ êµ¬ì¡° ìƒì„±ì„ ìœ„í•œ base file ì¶”ê°€ë¡œ ìƒì„±
       ```
       # vi base.ldif

       dn: dc=test,dc=local
       dc: test
       objectClass: top
       objectClass: domain
       
       
       dn: cn=ldapadm, dc=test,dc=local
       objectClass: organizationalRole
       cn: ldapadm
       description: LDAP Manager
       
       dn: ou=People, dc=test,dc=local
       objectClass: organizationalUnit
       ou: People
       
       dn: ou=Group, dc=test,dc=local
       objectClass: organizationalUnit
       ou: Group
       ```
       ```
       # ldapadd -x -W -D "cn=ldapadm,dc=test,dc=local" -f base.ldif
       ```
       - `-x` : ê°„ë‹¨í•œ ì¸ì¦ ì‚¬ìš© (SASL ëŒ€ì‹ )
       - `-W` : ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì„ ìš”ì²­ (-w <password> ë³´ë‹¤ ì•ˆì „)
       - `-D "cn=ldapadm,dc=test,dc=local"` : LDAP ê´€ë¦¬ì ê³„ì • (ë°”ì¸ë”©í•  DN)
       - `-f base.ldif` : ì¶”ê°€í•  LDAP ë°ì´í„°ê°€ í¬í•¨ëœ LDIF íŒŒì¼
       
<br>

ğŸŒŸì—¬ê¸°ê¹Œì§€ê°€ Masterì™€ Slave ì„œë²„ì˜ ê¸°ë³¸ ì„¸íŒ…. ì•„ë˜ë¶€í„°ëŠ” Master/Slave êµ¬ë¶„í•˜ì—¬ ì§„í–‰!!!ğŸŒŸ

<br>

---

<br>

### <mark style='background-color: #ffdce0'> 2. Master Server ì„¸íŒ… </mark>
- ì‹œì‘í•˜ê¸° ì „ ì‹ ê·œ root ê³„ì •ì„ ë”°ë¡œ ìƒì„±í•˜ë„ë¡ í•¨
- ldapadmì„ ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ ë³´ì•ˆì  ì´ìŠˆë¡œ ê¶Œì¥í•˜ì§€ëŠ” ì•ŠìŒ.

<br>

#### 2.1 ì‹ ê·œ root ê³„ì • ìƒì„±
- ì•„ë˜ íŒŒì¼ ìƒì„± ì‹œ provider êµ¬ë¬¸ë¶€í„° ê³µë°± ë„£ì–´ì¤˜ì•¼ í•¨
```
# vi rpuser.ldif

dn: olcDatabase={2}hdb,cn=config
changetype: modify
add: olcSyncRepl
olcSyncRepl: rid=300
  provider=ldap://192.168.56.11/
  bindmethod=simple
  binddn="uid=rpuser,dc=test,dc=local"
  credentials=1111
  searchbase="dc=test,dc=local"
  scope=sub
  schemachecking=on
  type=refreshAndPersist
  retry="30 5 300 3"
  interval=00:00:05:00
```

```
# ldapadd -x -W -D "cn=ldapadm,dc=test,dc=local" -f rpuser.ldif
```

#### 2.2 slaveë¡œ replicationì´ ë  ìˆ˜ ìˆë„ë¡ ì„¤ì •
- syncprov ëª¨ë“ˆì„ ì´ìš©
- `syncprov` : Synchronization Provider
   - í´ë¼ì´ì–¸íŠ¸(slave)ì—ê²Œ ë³€ê²½ì‚¬í•­ ì œê³µ
   -  replication ë°©ì‹ ì§€ì›
      - RefreshOnly : ì£¼ê¸°ì ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ì„ ìš”ì²­í•˜ì—¬ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ì‹
      - RefreshAndPersist: ì§€ì†ì ìœ¼ë¡œ ì—°ê²°ì„ ìœ ì§€í•˜ë©° ë³€ê²½ì‚¬í•­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ì‹
   -  Dalta-Sync ì§€ì›
      - ë³€ê²½ì‚¬í•­ ì „ì²´ë¥¼ ë™ê¸°í™”í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë³€ê²½ëœ ë¶€ë¶„ë§Œ ë™ê¸°í™”í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ì¤„ì„
   
```
# vi syncprov_mod.ldif

dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulePath: /usr/lib64/openldap
olcModuleLoad: syncprov.la
```
```
ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov_mod.ldif
```
```
# vi syncprov.ldif

dn: olcOverlay=syncprov,olcDatabase={2}hdb,cn=config
objectClass: olcOverlayConfig
objectClass: olcSyncProvConfig
olcOverlay: syncprov
olcSpSessionLog: 100
```
```
ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov.ldif
```

<br>

---

<br>

### <mark style='background-color: #ffdce0'> 3. Slave Server ì„¸íŒ… </mark>
- Slave ì„œë²„ì— LDAP ì„œë²„ì˜ ì •ë³´ë¥¼ ë„£ì–´ replicationì´ ë  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
```
# vi rp.ldif

dn: olcDatabase={2}hdb,cn=config
changetype: modify
add: olcSyncRepl
olcSyncRepl: rid=300
  provider=ldap://192.168.56.11/
  bindmethod=simple
  binddn="uid=rpuser,dc=test,dc=local"
  credentials=1111
  searchbase="dc=test,dc=local"
  scope=sub
  schemachecking=on
  type=refreshAndPersist
  retry="30 5 300 3"
  interval=00:00:05:00
```
```
# ldapadd -Y EXTERNAL -H ldapi:/// -f rp.ldif
```

#### â¡ï¸ Master-Slave êµ¬ì¡°ë¡œ LDAP êµ¬ì¶• ë° replication ì„¸íŒ…ê¹Œì§€ ì™„ë£Œ!

<br>

---

<br>

### <mark style='background-color: #ffdce0'> 4. ê³„ì • ìƒì„±ì„ í†µí•œ replication ì •ìƒ ë™ì‘ ì—¬ë¶€ í™•ì¸ </mark>
- í…ŒìŠ¤íŠ¸ ê³„ì •ì„ ë§Œë“¤ê¸° ìœ„í•œ íŒŒì¼ í•˜ë‚˜ ìƒì„±
- í•„ìëŠ” ecore ê³„ì •ì„ Master ì„œë²„ì— ìƒì„±í•˜ì˜€ìŒ

```
# vi ecore.ldif

dn: uid=ecore,ou=People,dc=test,dc=local
objectClass: top
objectClass: account
objectClass: posixAccount
objectClass: shadowAccount
cn: ecore
uid: ecore
uidNumber: 9989
gidNumber: 100
homeDirectory: /home/ecore
loginShell: /bin/bash
gecos: LDAP Replication Test User
userPassword: 1111
shadowLastChange: 17058
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
```
```
# ldapadd -x -W -D "cn=ldapadm,dc=test,dc=local" -f ecore.ldif
```

- ê³„ì • ìƒì„± í™•ì¸
   ```
   # ldapsearch -x cn=ecore -b dc=test,dc=local
   ```
   - `-x` : SASL ì¸ì¦ ë¹„í™œì„±í™”, ê°„ë‹¨í•œ ì¸ì¦ë°©ì‹ ì‚¬ìš©
   - `-b dc=test,dc=local` : ê²€ìƒ‰ì„ ì‹œì‘í•  ë£¨íŠ¸(Base Distinguished Name, Base DN) ì§€ì •
        - `dc=test,dc=local`ì€ LDAP íŠ¸ë¦¬ì˜ ìµœìƒìœ„ ë…¸ë“œë¥¼ ì˜ë¯¸
        - ì´ í•˜ìœ„ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ê°ì²´ë¥¼ ê²€ìƒ‰ ëŒ€ìƒìœ¼ë¡œ ì‚¼ìŒ

<br>

   - master ì„œë²„ì—ì„œ ê³„ì •ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ <br>
   ![Image](https://github.com/user-attachments/assets/94b7df78-0105-4f2c-a1a2-7758cdd07612)

<br>

   - slave ì„œë²„ì—ì„œ ê³„ì •ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ <br>
     ![Image](https://github.com/user-attachments/assets/83368dc3-2be5-4c72-a8e6-bb0153b81aab)

# 이중화 구성 테스트
<br>

### 테스트 환경
`docker` : Slave
`docker2` : Master

|Hostname|IP|Role|
|-----|------|------|
|docker1|192.168.56.11|Master (Provider)|
|docker2|192.168.56.12|Slave (Consumer)|

![Image](https://github.com/user-attachments/assets/b348ed22-f2ad-4693-bd95-b732a131dfeb)

<br>

---

### 1. Master, Slave 공통 환경 생성
- 두 대의 LDAP 서버를 Master-Slave 구조로 만들기 전, ldap 서비스 설치
- 아래 설정은 두 대에 모두 동일하게 적용

<br>

1. 필요 패키지 설치
   ```
   yum -y install openldap compat-openldap openldap-clients openldap-servers openldap-servers-sql openldap-devel
   ```

2. slapd 데몬 자동시작 설정 및 구동
   ```
   # systemctl start slapd
   # systemctl enable slapd
   ```

3. 389 port가 정상적으로 listen 중인지 확인 후, 방화벽에 해당 포트 허용 추가
   ```
   # netstat-tupln | grep 389
   # firewalld-cmd --permanent --zone=public --add-port=389/tcp
   # firewalld-cmd --zone=public -add-port=389/tcp
   // 난 그냥 방화벽 끄고 진행하뮤
   ```

4. LDAP 관련 로그를 생성하기 위한 rsyslog 설정 변경
   ```
   # vi /etc/rsyslog.conf
   ```
   ![Image](https://github.com/user-attachments/assets/0ffef99d-32bc-4789-a2c7-527386d3f590)
   ```
   # systemctl restart rsyslog
   ```

5. /etc/hosts에 각 서버의 정보 넣기
   ```
   # vi /etc/hosts
   ```
   ![Image](https://github.com/user-attachments/assets/af7f62f7-b24c-4d29-8be1-6d8a13462288)

6. LDAP Admin Password 세팅
   ```
   # slappasswd

   New password:
   Re-enter new password:
   {SSHA}JCTZ/3YY6qxVBQ49pX9sij1ghSt1Su2n
   ```

7. LDAP 서버 설정
   - 설정파일을 직접 수정하지 않고 새로운 파일을 생성하여 적용시킬 것임
   - 수정할 내용
      - `olcSuffix` : Database Suffix로, LDAP 서버가 정보를 제공하는 도메인 이름. 여기서는 test.local에 해당
      - `olcRootDN` : root 유저처럼 LDAP에 있어 모든 관리자 권한을 수행하는 유저를 위한 RDN (Root Distinguished Name) Entry
      - `olcRootPW` : 위 RootDN을 위한 Root PW

    #### 7.1 파일 설정
    ```
    # vi db.ldif
    
    dn: olcDatabase={2}hdb,cn=config
    changetype: modify
    replace: olcSuffix
    olcSuffix: dc=test,dc=local
    
    dn: olcDatabase={2}hdb,cn=config
    changetype: modify
    replace: olcRootDN
    olcRootDN: cn=ldapadm,dc=test,dc=local
    
    dn: olcDatabase={2}hdb,cn=config
    changetype: modify
    replace: olcRootPW
    olcRootPW: {SSHA}JCTZ/3YY6qxVBQ49pX9sij1ghSt1Su2n
    ```
    
    #### 7.2 파일 적용
    ```
    # ldapmodify -Y EXTERNAL -H ldapi:/// -f db.ldif
    
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    modifying entry "olcDatabase={2}hdb,cn=config"
    modifying entry "olcDatabase={2}hdb,cn=config"
    modifying entry "olcDatabase={2}hdb,cn=config"
    ```
    
    #### 7.3 monitor.ldif 생성 (root 사용자만 접근할 수 있도록)
    ```
    # vi monitor.ldif
    ```
    ```
    [root@docker2 ~]# ldapmodify -Y EXTERNAL -H ldapi:/// -f monitor.ldif
    SASL/EXTERNAL authentication started
    SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
    SASL SSF: 0
    modifying entry "olcDatabase={1}monitor,cn=config"
    ```

  8. LDAP DB 설정
     - DB 샘플 파일을 cp한 후, 권한 수정
       ```
       [root@docker2 ~]# cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
       [root@docker2 ~]# chown ldap:ldap /var/lib/ldap/*
       ```

     - LDAP DB에 consine과 nis 스키마 추가
       ```
       # ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
       # ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif 
       # ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif
       ```

     - 도메인 구조 생성을 위한 base file 추가로 생성
       ```
       # vi base.ldif

       dn: dc=test,dc=local
       dc: test
       objectClass: top
       objectClass: domain
       
       
       dn: cn=ldapadm, dc=test,dc=local
       objectClass: organizationalRole
       cn: ldapadm
       description: LDAP Manager
       
       dn: ou=People, dc=test,dc=local
       objectClass: organizationalUnit
       ou: People
       
       dn: ou=Group, dc=test,dc=local
       objectClass: organizationalUnit
       ou: Group
       ```
       ```
       # ldapadd -x -W -D "cn=ldapadm,dc=test,dc=local" -f base.ldif
       ```
<br>

🌟여기까지가 Master와 Slave 서버의 기본 세팅. 아래부터는 Master/Slave 구분하여 진행!!!🌟

---

### 2. Master Server 세팅
